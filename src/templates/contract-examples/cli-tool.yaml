roles:
  - id: architect
    scope: ["vision.md", "architecture.md"]
    authority: { allowedCommands: ["npm test"], allowedPaths: ["**/*"] }
    outputExpectations: ["planning artifacts", "delegation plan"]
    verificationMethod: { kind: "none" }
    budget: { maxIterations: 2, exhaustionEscalation: "exception_gate" }
  - id: core
    scope: ["src/**", "tests/**"]
    authority: { allowedCommands: ["npm test"], allowedPaths: [] }
    outputExpectations: ["implementation", "tests (feature-level)"]
    verificationMethod: { kind: "none" }
    budget: { maxIterations: 3, exhaustionEscalation: "architect" }
    behavioralGuidance: |
      Own TDD for code changes: red → green → refactor.
      Add/adjust tests for each behavior change; keep increments small and leave the suite green.
  - id: sdet
    scope: ["tests/**", "e2e/**", ".github/**"]
    authority: { allowedCommands: ["npm test"], allowedPaths: [] }
    outputExpectations: ["test harness/CI", "integration coverage", "flake reduction"]
    verificationMethod: { kind: "none" }
    budget: { maxIterations: 2, exhaustionEscalation: "architect" }
  - id: docs
    scope: ["README.md", "docs/**"]
    authority: { allowedCommands: [], allowedPaths: [] }
    outputExpectations: ["README.md (ship-ready)"]
    verificationMethod: { kind: "none" }
    budget: { maxIterations: 2, exhaustionEscalation: "architect" }

sharedScopes:
  - roles: ["core", "sdet"]
    patterns: ["tests/**"]

phases:
  - id: planning
    actors: ["architect"]
    inputBoundaries: ["vision.md", "architecture.md"]
    outputBoundaries: [".nibbler/jobs/**/plan/**"]
    preconditions: [{ type: "always" }]
    completionCriteria:
      - { type: "artifact_exists", pattern: ".nibbler/jobs/**/plan/**" }
    successors: [{ on: "done", next: "execution" }]
  - id: execution
    actors: ["core", "sdet"]
    inputBoundaries: ["src/**", "tests/**"]
    outputBoundaries: ["src/**", "tests/**"]
    preconditions: [{ type: "always" }]
    completionCriteria:
      - { type: "diff_non_empty" }
      - { type: "command_succeeds", command: "npm test" }
    successors: [{ on: "done", next: "ship" }]
  - id: ship
    actors: ["docs"]
    inputBoundaries: ["**/*"]
    outputBoundaries: ["README.md", "docs/**"]
    preconditions: [{ type: "always" }]
    completionCriteria:
      - { type: "artifact_exists", pattern: "README.md" }
      - { type: "markdown_has_headings", path: "README.md", requiredHeadings: ["Install", "Quickstart", "Commands", "Local development"], minChars: 250 }
    successors: []
    isTerminal: true

gates:
  - id: plan
    trigger: "planning->execution"
    audience: "PO"
    approvalScope: "build_requirements"
    approvalExpectations:
      - "Approve the product requirements and MVP command scope for this CLI build."
      - "Approve the execution approach and validation plan before implementation."
    businessOutcomes:
      - "The CLI value proposition and priorities are confirmed by the PO."
      - "The delivery team is authorized to build the approved command surface."
    functionalScope:
      - "Primary commands, flags, and expected outputs are mapped to implementation tasks."
      - "Acceptance artifacts define usability and behavior expectations."
    outOfScope:
      - "Commands not listed in approved planning artifacts are excluded."
      - "Advanced automation and extensions are deferred beyond MVP."
    requiredInputs:
      - { name: "vision", kind: "path", value: "vision.md" }
      - { name: "architecture", kind: "path", value: "architecture.md" }
    outcomes: { approve: "execution", reject: "planning" }
  - id: ship
    trigger: "ship->__END__"
    audience: "PO"
    approvalScope: "phase_output"
    approvalExpectations:
      - "Approve ship-phase artifacts for release."
    businessOutcomes:
      - "PO confirms the CLI package is ready for user adoption."
    functionalScope:
      - "README includes install, usage examples, and command reference expectations."
    outOfScope:
      - "No additional command scope is approved at SHIP."
    requiredInputs:
      - { name: "readme", kind: "path", value: "README.md" }
    outcomes: { approve: "__END__", reject: "ship" }

globalLifetime:
  maxTimeMs: 1800000

escalationChain: []
